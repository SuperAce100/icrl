---
title: CurationManager
description: "Automatic pruning of low-utility trajectories"
---

## Overview

`CurationManager` handles automatic pruning of trajectories that don't contribute to successful episodes. It tracks utility scores and removes trajectories that fall below the threshold.

```python
from icrl.curation import CurationManager
```

## Constructor

```python
CurationManager(
    database: TrajectoryDatabase,
    threshold: float = 0.3,
    min_retrievals: int = 5,
    curate_every: int = 10,
)
```

### Parameters

<ParamField path="database" type="TrajectoryDatabase" required>
  The trajectory database to curate.
</ParamField>

<ParamField path="threshold" type="float" default="0.3">
  Utility score threshold below which trajectories are pruned. Range: 0.0 to 1.0.
</ParamField>

<ParamField path="min_retrievals" type="int" default="5">
  Minimum number of times a trajectory must be retrieved before it can be considered for pruning.
</ParamField>

<ParamField path="curate_every" type="int" default="10">
  Run curation after this many successful episodes.
</ParamField>

## Methods

### maybe_curate

```python
def maybe_curate(self) -> bool
```

Check if curation should run and run it if so.

<ResponseField name="return" type="bool">
  `True` if curation was performed, `False` otherwise.
</ResponseField>

```python
# Called after each successful training episode
if curation.maybe_curate():
    print("Curation was performed")
```

### curate

```python
def curate(self) -> list[str]
```

Run curation to prune low-utility trajectories.

<ResponseField name="return" type="list[str]">
  List of trajectory IDs that were removed.
</ResponseField>

```python
removed_ids = curation.curate()
print(f"Pruned {len(removed_ids)} trajectories")
```

### get_utility_scores

```python
def get_utility_scores(self) -> dict[str, float]
```

Get utility scores for all trajectories.

<ResponseField name="return" type="dict[str, float]">
  Dictionary mapping trajectory IDs to their utility scores.
</ResponseField>

```python
scores = curation.get_utility_scores()
for traj_id, score in scores.items():
    print(f"{traj_id}: {score:.2f}")
```

### get_low_utility_trajectories

```python
def get_low_utility_trajectories(self) -> list[str]
```

Get trajectory IDs that would be pruned if curation ran now.

<ResponseField name="return" type="list[str]">
  List of trajectory IDs with low utility that meet pruning criteria.
</ResponseField>

```python
# Preview what would be pruned
low_utility = curation.get_low_utility_trajectories()
print(f"Would prune {len(low_utility)} trajectories")

for traj_id in low_utility:
    traj = db.get(traj_id)
    print(f"  - {traj.goal[:50]}...")
```

## Utility Calculation

The utility score for a trajectory is:

```
utility_score = times_led_to_success / times_retrieved
```

A trajectory is pruned when:
1. `times_retrieved >= min_retrievals`
2. `utility_score < threshold`

## Example Usage

### Basic Usage

```python
from icrl.database import TrajectoryDatabase
from icrl.curation import CurationManager

db = TrajectoryDatabase("./trajectories")
curation = CurationManager(
    database=db,
    threshold=0.3,
    min_retrievals=5,
)

# Check curation after each success
curation.maybe_curate()

# Or force curation
removed = curation.curate()
```

### With Agent

The agent manages curation automatically:

```python
from icrl import Agent

agent = Agent(
    llm=llm,
    db_path="./trajectories",
    plan_prompt="...",
    reason_prompt="...",
    act_prompt="...",
    curation_threshold=0.3,
    curation_min_retrievals=5,
)

# Curation happens automatically after successful training
trajectory = await agent.train(env, goal)
```

### Monitoring Curation

```python
# Get current scores
scores = agent._curation.get_utility_scores()
print(f"Tracking {len(scores)} trajectories")

# Find best performers
sorted_scores = sorted(scores.items(), key=lambda x: x[1], reverse=True)
print("\nTop 5 trajectories:")
for traj_id, score in sorted_scores[:5]:
    traj = agent.database.get(traj_id)
    print(f"  {score:.2f}: {traj.goal[:50]}...")

# Find candidates for pruning
low = agent._curation.get_low_utility_trajectories()
print(f"\nCandidates for pruning: {len(low)}")
```

### Custom Curation Strategies

```python
# Conservative: keep more trajectories
curation = CurationManager(
    database=db,
    threshold=0.1,       # Only prune truly bad
    min_retrievals=10,   # Need more evidence
    curate_every=20,     # Curate less frequently
)

# Aggressive: prune more
curation = CurationManager(
    database=db,
    threshold=0.5,      # High bar
    min_retrievals=3,   # Prune quickly
    curate_every=5,     # Curate often
)
```

### Adjusting at Runtime

```python
# Start conservative
agent = Agent(..., curation_threshold=0.1, curation_min_retrievals=10)

# Train for a while
for goal in training_goals[:50]:
    await agent.train(make_env(), goal)

# Now tighten curation
agent._curation._threshold = 0.3
agent._curation._min_retrievals = 5

# Continue training
for goal in training_goals[50:]:
    await agent.train(make_env(), goal)
```

## Curation Metadata

Each trajectory has associated metadata:

```python
from icrl.models import CurationMetadata

# The database stores this for each trajectory
metadata = CurationMetadata(
    trajectory_id="uuid-here",
    times_retrieved=10,
    times_led_to_success=7,
    utility_score=0.7,
)
```

Access via the database:

```python
meta = db.get_curation_metadata(trajectory.id)
if meta:
    print(f"Retrieved: {meta.times_retrieved}")
    print(f"Successes: {meta.times_led_to_success}")
    print(f"Utility: {meta.utility_score:.2f}")
```

## Internal Behavior

### Curation Frequency

```python
def maybe_curate(self) -> bool:
    self._episodes_since_curation += 1
    
    if self._episodes_since_curation >= self._curate_every:
        self.curate()
        self._episodes_since_curation = 0
        return True
    
    return False
```

### Pruning Logic

```python
def curate(self) -> list[str]:
    removed_ids = []
    
    for trajectory in self._database.get_all():
        metadata = self._database.get_curation_metadata(trajectory.id)
        
        if metadata is None:
            continue
        
        # Not enough data yet
        if metadata.times_retrieved < self._min_retrievals:
            continue
        
        # Below threshold
        if metadata.utility_score < self._threshold:
            if self._database.remove(trajectory.id):
                removed_ids.append(trajectory.id)
    
    return removed_ids
```

## See Also

- [TrajectoryRetriever](/api-reference/trajectory-retriever) - Tracks retrievals
- [TrajectoryDatabase](/api-reference/trajectory-database) - Stores metadata
- [Curation Concepts](/core-concepts/curation) - Overview
