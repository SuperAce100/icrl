---
title: File System Agent
description: "Complete example of an ICICL agent navigating a virtual file system"
---

## Overview

This example demonstrates a complete ICICL agent that navigates a simulated file system to accomplish tasks like finding files, reading contents, and copying data.

## The Environment

First, we define a simulated file system environment:

```python
from pathlib import PurePosixPath
from dataclasses import dataclass, field
from collections.abc import Callable

@dataclass
class FileSystemState:
    """Tracks the current state of the virtual file system."""
    cwd: str = "/"
    last_output: str = ""
    files: dict[str, str] = field(default_factory=dict)
    directories: set[str] = field(default_factory=set)

@dataclass
class Task:
    """A verifiable task for the file system environment."""
    goal: str
    verify: Callable[[FileSystemState], bool]

class FileSystemEnvironment:
    """Simulated file system implementing the Environment protocol."""
    
    def __init__(self, task: Task):
        self._task = task
        self._state = FileSystemState()
        self._max_actions = 20
        self._action_count = 0
    
    def reset(self, goal: str) -> str:
        # Initialize virtual file tree
        self._state = FileSystemState(
            cwd="/",
            files={
                "/home/user/notes.txt": "Meeting notes:\n- Review code\n- Plan sprint",
                "/home/user/projects/main.py": 'print("Hello, World!")',
                "/etc/app/config.json": '{"port": 8080, "db_password": "secret123"}',
            },
            directories={
                "/", "/home", "/home/user", "/home/user/projects",
                "/etc", "/etc/app", "/backup", "/tmp",
            },
        )
        self._action_count = 0
        return f"Current directory: /\nGoal: {self._task.goal}"
    
    def step(self, action: str) -> tuple[str, bool, bool]:
        self._action_count += 1
        
        if self._action_count >= self._max_actions:
            return "Maximum actions reached.", True, False
        
        observation = self._execute_action(action)
        self._state.last_output = observation
        
        success = self._task.verify(self._state)
        if success:
            return f"{observation}\n[Task completed!]", True, True
        
        return observation, False, False
    
    def _execute_action(self, action: str) -> str:
        parts = action.strip().split(maxsplit=1)
        cmd = parts[0].lower() if parts else ""
        args = parts[1] if len(parts) > 1 else ""
        
        if cmd == "ls":
            return self._cmd_ls(args)
        elif cmd == "cd":
            return self._cmd_cd(args)
        elif cmd == "cat":
            return self._cmd_cat(args)
        elif cmd == "pwd":
            return self._state.cwd
        elif cmd == "find":
            return self._cmd_find(args)
        elif cmd == "cp":
            return self._cmd_cp(args)
        elif cmd == "mkdir":
            return self._cmd_mkdir(args)
        else:
            return f"Unknown command: {cmd}"
    
    # Command implementations...
    def _cmd_ls(self, args: str) -> str:
        path = args.strip() or self._state.cwd
        # List directory contents
        ...
    
    def _cmd_cd(self, args: str) -> str:
        # Change directory
        ...
    
    def _cmd_cat(self, args: str) -> str:
        # Read file
        ...
```

<Note>
See `examples/file_api_env.py` in the repository for the complete implementation.
</Note>

## Defining Tasks

Tasks specify a goal and a verification function:

```python
# Easy tasks
easy_tasks = [
    Task(
        goal="Navigate to /home/user/projects and list the files",
        verify=lambda s: s.cwd == "/home/user/projects" and "main.py" in s.last_output,
    ),
    Task(
        goal="Find the database password in the config files",
        verify=lambda s: "secret123" in s.last_output,
    ),
]

# Hard tasks
hard_tasks = [
    Task(
        goal="Copy notes.txt to the /backup directory",
        verify=lambda s: s.file_exists("/backup/notes.txt"),
    ),
    Task(
        goal="Find main.py and copy it to /backup",
        verify=lambda s: s.file_exists("/backup/main.py"),
    ),
]
```

## Prompt Templates

Design prompts that describe available commands and guide the agent:

```python
PLAN_PROMPT = """You are a file system navigation agent. Available commands:
- ls [dir] - list directory contents
- cd <dir> - change directory
- cat <file> - display file contents
- find <pattern> - search for files
- pwd - print working directory
- mkdir <name> - create directory
- cp <src> <dst> - copy file

Goal: {goal}

Previous successful examples:
{examples}

Create a brief, numbered plan to accomplish the goal."""

REASON_PROMPT = """You are navigating a file system.

Goal: {goal}
Your plan: {plan}

Previous steps:
{history}

Current observation: {observation}

Examples from similar situations:
{examples}

Think step by step: What did you observe? What should you do next?"""

ACT_PROMPT = """Goal: {goal}
Plan: {plan}
History: {history}
Observation: {observation}
Reasoning: {reasoning}

What is the SINGLE next command? Respond with only the command."""
```

## Creating the Agent

```python
import asyncio
from icicl import Agent, LiteLLMProvider, Step, StepContext

# Step callback for monitoring
def on_step(step: Step, context: StepContext) -> None:
    print(f"\nüìç Observation: {step.observation[:100]}...")
    print(f"ü§î Reasoning: {step.reasoning[:100]}...")
    print(f"‚ñ∂Ô∏è Action: {step.action}")
    print(f"üìö Examples: {len(context.examples)}")

# Create the agent
agent = Agent(
    llm=LiteLLMProvider(model="gpt-4o-mini", temperature=0.3),
    db_path="./file_agent_trajectories",
    plan_prompt=PLAN_PROMPT,
    reason_prompt=REASON_PROMPT,
    act_prompt=ACT_PROMPT,
    k=2,
    max_steps=15,
    on_step=on_step,
)
```

## Training

Train the agent on multiple tasks:

```python
async def train_agent():
    print("=== Training Phase ===")
    
    training_tasks = [
        Task(goal="Navigate to /home/user and list files", 
             verify=lambda s: s.cwd == "/home/user"),
        Task(goal="Find the port number in /etc/app/config.json",
             verify=lambda s: "8080" in s.last_output),
        Task(goal="Copy notes.txt from /home/user to /backup",
             verify=lambda s: s.file_exists("/backup/notes.txt")),
    ]
    
    for i, task in enumerate(training_tasks, 1):
        print(f"\n--- Task {i}/{len(training_tasks)} ---")
        print(f"Goal: {task.goal}")
        
        env = FileSystemEnvironment(task)
        trajectory = await agent.train(env, task.goal)
        
        if trajectory.success:
            print(f"‚úÖ Success in {len(trajectory.steps)} steps")
        else:
            print(f"‚ùå Failed after {len(trajectory.steps)} steps")
    
    # Check database
    stats = agent.get_stats()
    print(f"\nStored: {stats['total_trajectories']} trajectories")
    print(f"Success rate: {stats['success_rate']:.1%}")

asyncio.run(train_agent())
```

## Evaluation

Test on held-out tasks:

```python
async def evaluate_agent():
    print("\n=== Evaluation Phase ===")
    
    eval_tasks = [
        Task(goal="Find all Python files in the system",
             verify=lambda s: "main.py" in s.last_output),
        Task(goal="Read the contents of the config file in /etc/app",
             verify=lambda s: "port" in s.last_output),
    ]
    
    results = []
    for task in eval_tasks:
        print(f"\nGoal: {task.goal}")
        
        # Show what examples will be retrieved
        similar = agent.database.search(task.goal, k=2)
        if similar:
            print("Retrieved examples:")
            for s in similar:
                print(f"  - {s.goal[:50]}...")
        
        env = FileSystemEnvironment(task)
        trajectory = await agent.run(env, task.goal)  # Inference mode
        
        results.append(trajectory.success)
        print(f"Result: {'‚úÖ Success' if trajectory.success else '‚ùå Failed'}")
    
    print(f"\nEval accuracy: {sum(results)}/{len(results)}")

asyncio.run(evaluate_agent())
```

## Complete Script

Here's the full runnable example:

```python
#!/usr/bin/env python3
"""File system navigation agent with ICICL."""

import asyncio
import os
import tempfile
from pathlib import Path

from dotenv import load_dotenv

from examples.file_api_env import FileSystemEnvironment, Task
from icicl import Agent, LiteLLMProvider, Step, StepContext

load_dotenv()

# Prompts
PLAN_PROMPT = """You are a file system navigation agent. Commands:
- ls [dir], cd <dir>, cat <file>, find <pattern>, pwd, mkdir <name>, cp <src> <dst>

Goal: {goal}

Examples:
{examples}

Create a numbered plan."""

REASON_PROMPT = """Goal: {goal}
Plan: {plan}
History: {history}
Observation: {observation}
Examples: {examples}

Think step by step about what to do next."""

ACT_PROMPT = """Goal: {goal}
Plan: {plan}
Reasoning: {reasoning}

Next command (only the command):"""


def on_step(step: Step, context: StepContext) -> None:
    print(f"  Action: {step.action}")


async def main():
    with tempfile.TemporaryDirectory() as tmpdir:
        agent = Agent(
            llm=LiteLLMProvider(
                model=os.environ.get("MODEL", "gpt-4o-mini"),
                temperature=0.3,
            ),
            db_path=str(Path(tmpdir) / "trajectories"),
            plan_prompt=PLAN_PROMPT,
            reason_prompt=REASON_PROMPT,
            act_prompt=ACT_PROMPT,
            k=2,
            max_steps=15,
            on_step=on_step,
        )
        
        # Training tasks
        training_tasks = [
            Task(
                goal="Navigate to /home/user/projects and list files",
                verify=lambda s: s.cwd == "/home/user/projects",
            ),
            Task(
                goal="Find the database password in the config files",
                verify=lambda s: "secret123" in s.last_output,
            ),
        ]
        
        print("=== Training ===")
        for task in training_tasks:
            print(f"\nGoal: {task.goal}")
            env = FileSystemEnvironment(task)
            traj = await agent.train(env, task.goal)
            print(f"Result: {'‚úÖ' if traj.success else '‚ùå'}")
        
        # Evaluation task
        eval_task = Task(
            goal="Find the port number in the config",
            verify=lambda s: "8080" in s.last_output,
        )
        
        print("\n=== Evaluation ===")
        print(f"Goal: {eval_task.goal}")
        env = FileSystemEnvironment(eval_task)
        traj = await agent.run(env, eval_task.goal)
        print(f"Result: {'‚úÖ' if traj.success else '‚ùå'}")
        
        # Stats
        stats = agent.get_stats()
        print(f"\nDatabase: {stats['total_trajectories']} trajectories")


if __name__ == "__main__":
    asyncio.run(main())
```

## Running the Example

```bash
# Set your API key
export OPENAI_API_KEY=your-key

# Run the demo
cd /path/to/icicl
uv run python examples/demo_with_real_llm.py
```

## Sample Output

```
=== Training ===

Goal: Navigate to /home/user/projects and list files
  Action: cd /home/user/projects
  Action: ls
Result: ‚úÖ

Goal: Find the database password in the config files
  Action: cd /etc/app
  Action: cat config.json
Result: ‚úÖ

=== Evaluation ===
Goal: Find the port number in the config
  Action: cd /etc/app
  Action: cat config.json
Result: ‚úÖ

Database: 2 trajectories
```

## Key Takeaways

1. **Environment Design**: Clear observations and verifiable success conditions
2. **Prompt Engineering**: Specific commands and structured thinking
3. **Training First**: Build up examples before evaluation
4. **Retrieval Helps**: Similar past experiences improve new task performance

## See Also

- [Custom Environments](/guides/custom-environments) - Build your own environments
- [Prompt Templates](/guides/prompt-templates) - Design effective prompts
- [Batch Training](/guides/batch-training) - Train on many tasks
